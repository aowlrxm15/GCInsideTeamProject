<?xml version="1.0" encoding="UTF-8"?>
<!-- 2023/03/08 // 심규영 // 메인 인덱스 xml 생성 -->
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.gcInside.dao.BoardDAO">
    <!-- create -->

    <!-- 2023/03/22 // 심규영 // 게시물 작성 쿼리문 -->
    <insert id="insertArticle" parameterType="map">
        INSERT INTO `gc_gell_article` SET
        `articlel_gell_num` = #{article_gell_num},
        `article_login_status` = #{userLogin},
        <if test="userLogin eq 0">
            `article_uid` = #{article_uid},
        </if>
        <if test="userLogin eq 1">
            `article_nonmember_uid` = #{nonmember_uid},
            `article_nonmember_pass` = #{nonmember_pass},
        </if>

        <if test="sub_cate_info eq 1">
            `article_sub_cate` = #{sub_cate},
        </if>
        `article_title` = #{article_title},
        `article_content` = #{article_content},
        `article_regip` = #{article_regip},
        `article_rdate` = NOW();
    </insert>

    <!-- read -->

    <!-- 2023/03/20 // 심규영 // 갤러리 정보 불러오기 -->
    <!-- 2023/03/23 // 심규영 // 갤러지 정보 불러오기 조건(grade) 추가 -->
    <!-- 2023/03/27 // 심규영 // 메인 갤러리 정보 불러오기 오류 해결 -->
    <!-- 2023/03/28 // 심규영 // 메인 갤러리 정보 불러오기 버그 최종 해결 -->
    <select id="selectGellInfo" resultMap="selectGellInfoResultMap">
        SELECT
            a.`gell_num`,
            a.`gell_name`,
            a.`gell_address`,
            a.`gell_main_img`,
            a.`gell_info`,
            a.`gell_manager`,
            a.`gell_grade`,
            a.`gell_rdate`,
            c.`member_nick`,
            b.`setting_sub_cate`,
            b.`setting_recommend_standard`,
            (SELECT COUNT(relation_num) FROM `gc_gell_relation_gell` WHERE relation_gell_num = a.gell_num) AS relation_count,
            (SELECT COUNT(relation_num) FROM `gc_gell_relation_gell` WHERE relation_relation_gell_num = a.gell_num) AS re_relation_count
        FROM `gc_gell` AS a
        JOIN `gc_gell_setting` AS b ON a.gell_num = b.setting_gell_num
        JOIN `gc_member` AS c ON a.`gell_manager` = c.`member_uid`
        WHERE a.gell_address = #{gell_address} AND a.`gell_grade` =
        <choose>
            <when test='grade.equals("m")'>0</when>
            <when test='grade.equals("mgall")'>1</when>
            <when test='grade.equals("mini")'>2</when>
        </choose>
        ;
    </select>

    <resultMap id="selectGellInfoResultMap" type="kr.co.gcInside.vo.galleryVO">
        <id column="gell_num" property="gell_num"/>
        <result column="gell_name" property="gell_name"/>
        <result column="gell_address" property="gell_address"/>
        <result column="gell_main_img" property="gell_main_img"/>
        <result column="gell_info" property="gell_info"/>
        <result column="gell_manager" property="gell_manager"/>
        <result column="gell_grade" property="gell_grade"/>
        <result column="gell_rdate" property="gell_rdate"/>
        <result column="member_nick" property="member_nick"/>
        <result column="relation_count" property="relation_count"/>
        <result column="re_relation_count" property="re_relation_count"/>

        <association property="gellSettingVO" javaType="kr.co.gcInside.vo.Gell_SettingVO">
            <result column="setting_sub_cate" property="setting_sub_cate"/>
            <result column="setting_recommend_standard" property="setting_recommend_standard"/>
        </association>
    </resultMap>

    <!-- 2023/03/24 // 심규영 // 갤러리 부매니저 정보 가져오는 쿼리문 -->
    <select id="selectSubManagerInfo" resultType="kr.co.gcInside.vo.Gell_sub_managerVO">
        SELECT a.*, b.`member_nick` FROM `gc_gell_sub_manager` AS a
        JOIN `gc_member` AS b ON a.`sub_manager_uid` = b.`member_uid`
        WHERE `sub_manager_gell_num` = #{gell_num};
    </select>

    <!-- 2023/03/23 // 심규영 // 게시글 리스트 가져오는 쿼리문 -->
    <select id="selectArticles" parameterType="map" resultType="kr.co.gcInside.vo.gell_articleVO">
        SELECT a.*, b.`member_nick` FROM `gc_gell_article` AS a
        left JOIN `gc_member` AS b ON a.`article_uid` = b.`member_uid`
        WHERE
        <if test="exception_mode == null">`article_status` = '0'</if> <!-- 출력 모드가 없을 경우 기본 설정 -->
        <if test="exception_mode != null"> <!-- 출력 모드가 있을 경우 -->
            <if test="exception_mode.equals('notice')">`article_status` = '2'</if>
            <if test="exception_mode.equals('recommend')">
                `article_status` = '0'
                AND
                `article_recommend_count` >= ${setting_recommend_standard} <!-- 추천글 기준보다 크거나 같다 -->
                OR
                `article_recommend_status` = '1' <!-- 관리자에 의해 추천글로 표시된 글 -->
            </if>
        </if>
        <if test="search_head != null"> <!-- 말머리 값이 있을 경우 -->
            AND `article_sub_cate`
            <if test="search_head.equals('0')">IS null</if> <!-- 일반 -->
            <if test="!search_head.equals('0')">= #{search_head}</if> <!-- 그외 -->
        </if>
        AND `articlel_gell_num` = #{gell_num}
        ORDER BY `article_num` DESC
        LIMIT ${start},
        <if test="list_num == null">50</if>
        <if test="list_num != null">${list_num}</if>
        ;
    </select>

    <!-- 2023/03/26 // 심규영 // 해당 게시글 정보 불러오는 쿼리문 -->
    <select id="selectArticle" parameterType="map" resultType="kr.co.gcInside.vo.gell_articleVO">
        SELECT a.*, b.`member_nick` FROM `gc_gell_article` AS a
        left JOIN `gc_member` AS b ON a.`article_uid` = b.`member_uid`
        WHERE `article_num` = #{no} AND `articlel_gell_num` = #{gell_num};
    </select>

    <!-- 2023/03/27 // 심규영 // 게시글 내용 불러오는 쿼리문 -->
    <select id="selectArticleEditor" parameterType="map" resultType="kr.co.gcInside.vo.gell_articleVO">
        SELECT `article_content` FROM `gc_gell_article` WHERE `article_num` = #{no};
    </select>

    <!-- 2023/03/23 // 심규영 // 게시글 리스트 총 갯수 가져오는 쿼리문 -->
    <select id="selectCountArticles" parameterType="map" resultType="int">
        SELECT COUNT(`article_num`) FROM `gc_gell_article` WHERE
        <if test="exception_mode == null">`article_status` = '0'</if> <!-- 출력 모드가 없을 경우 기본 설정 -->
        <if test="exception_mode != null"> <!-- 출력 모드가 있을 경우 -->
            <if test="exception_mode.equals('notice')">`article_status` = '2'</if>
            <if test="exception_mode.equals('recommend')">
                `article_status` = '0'
                AND
                `article_recommend_count` >= ${setting_recommend_standard} <!-- 추천글 기준보다 크거나 같다 -->
                OR
                `article_recommend_status` = '1' <!-- 관리자에 의해 추천글로 표시된 글 -->
            </if>
        </if>
        <if test="search_head != null"> <!-- 말머리 값이 있을 경우 -->
            AND `article_sub_cate`
            <if test="search_head.equals('0')">IS null</if> <!-- 일반 -->
            <if test="!search_head.equals('0')">= #{search_head}</if> <!-- 그외 -->
        </if>
        ;
    </select>

    <!-- 2023/03/22 // 심규영 // 갤러리 존재 확인 쿼리문 -->
    <select id="selectGellCheck" resultType="int">
        SELECT COUNT(`gell_num`) FROM `gc_gell` WHERE `gell_num` = ${gell_num};
    </select>

    <!-- 2023/03/22 // 심규영 // 유저 정보 존재 확인 쿼리문 -->
    <!-- 2023/03/27 // 심규영 // 글작성 에러 수정 -->
    <select id="selectMemberCheck" resultType="int">
        SELECT COUNT(`member_uid`) FROM `gc_member` WHERE `member_uid` = #{member_uid};
    </select>

    <!-- 2023/03/22 // 심규영 // 말머리 확인 쿼리문 -->
    <select id="selectSubCateCheck" resultType="int">
        SELECT COUNT(`sub_cate_num`) FROM `gc_gell_sub_cate` WHERE `sub_cate_gell_num` = ${gell_num} AND `sub_cate_sequence` = ${sub_cate};
    </select>

    <!-- 2023/03/27 // 심규영 // 비회원 게시글 비밀번호 체크 쿼리문 -->
    <select id="selectNonmemberCheck" parameterType="map" resultType="int">
        SELECT COUNT(`article_num`) FROM `gc_gell_article` WHERE
            `article_num` = #{no}
        AND `articlel_gell_num` = #{id}
        AND `article_login_status` = 1
        AND `article_nonmember_pass` = #{pass};
    </select>

    <!-- upload -->
    <update id="updateArticle" parameterType="map">
        UPDATE `gc_gell_article` SET
            `article_title` = #{article_title},
            `article_content` = #{content}
        WHERE `article_num` = #{modify_no} AND `articlel_gell_num` = #{gell_num}
        <if test='!modify_uid.equals("")'>AND `article_uid` = #{modify_uid}</if>
    </update>
    
    <!-- delete -->
</mapper>